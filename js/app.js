function FileHelper_blow(errmsg){this.clearFileInput();utl.id("load-file-error").style.display="block";utl.id("load-file-error").innerHTML=errmsg;window.setTimeout(function(){utl.id("load-file-error").style.visibility="hidden"},200);window.setTimeout(function(){utl.id("load-file-error").style.visibility="visible"},400);window.setTimeout(function(){utl.id("load-file-error").style.visibility="hidden"},600);window.setTimeout(function(){utl.id("load-file-error").style.visibility="visible"},800)}function FileHelper_clearFileInput(){var inp=utl.id("load-file");inp.value="";if(inp.value){inp.type="text";inp.type="file"}}function FileHelper_feedDocx(data){var zip=new JSZip;try{zip.load(data)}catch(err){return this.blow(lang.dict()["Err_msw1"])}var rels=utl.create("div",{innerHTML:zip.files["_rels/.rels"].asText()});rels=rels.getElementsByTagName("Relationship");if(!rels)return this.blow(lang.dict()["Err_msw2"]);var doc=false;for(var i=0;i<rels.length;i++)if(rels[i].getAttribute("Type")=="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"){doc=rels[i].getAttribute("Target");break}if(!doc)return this.blow(lang.dict()["Err_msw3"]);var docBody=utl.create("div",{innerHTML:zip.files[doc].asText()});docBody=docBody.getElementsByTagName("w:body")[0];if(!docBody)return this.blow(lang.dict()["Err_msw4"]);docBody.innerHTML=docBody.innerHTML.split("</w:p>").join("\n</w:p>");if(utl.id("load-notes").checked){var refs=docBody.getElementsByTagName("w:footnoteReference");for(var i=0;i<refs.length;i++)refs[i].innerHTML="("+(i+1)+")";var refs=docBody.getElementsByTagName("w:endnoteReference");for(var i=0;i<refs.length;i++)refs[i].innerHTML="["+(i+1)+"]"}if(chlonnik.mode=="results")chlonnik.mainButtonHandler();var content=docBody.textContent;if(utl.id("load-notes").checked){for(var i=doc.length-1;doc[i]!="/";i--);var docPath=doc.substr(0,i),docName=doc.substr(i+1);rels=zip.files[docPath+"/_rels/"+docName+".rels"];if(rels&&rels.asText){rels=utl.create("div",{innerHTML:rels.asText()});rels=rels.getElementsByTagName("Relationship");for(var i=0;i<rels.length;i++){var relType=rels[i].getAttribute("Type");if(relType.substr(relType.length-24)=="/relationships/footnotes"||relType.substr(relType.length-23)=="/relationships/endnotes"){var target=rels[i].getAttribute("Target");if(target.charAt(0)=="/")var notes=zip.files[target];else var notes=zip.files[docPath+"/"+target];if(!notes)continue;notes=utl.create("div",{innerHTML:notes.asText()});content+="\n";if(relType.substr(relType.length-24)=="/relationships/footnotes"){notes=notes.getElementsByTagName("w:footnote");for(var j=0,k=1;j<notes.length;j++){if(notes[j].textContent)content+="("+k++ +") "+notes[j].textContent+"\n"}}else{notes=notes.getElementsByTagName("w:endnote");for(var j=0,k=1;j<notes.length;j++){if(notes[j].textContent)content+="["+k++ +"] "+notes[j].textContent+"\n"}}}}}}utl.id("text-input").value=content;chlonnik.mainButtonHandler();chlonnik.fileButtonHandler()}function FileHelper(){}FileHelper.prototype.blow=FileHelper_blow;FileHelper.prototype.clearFileInput=FileHelper_clearFileInput;FileHelper.prototype.feedDocx=FileHelper_feedDocx;function OneWordHelper(){this.p_currentWord="";this.locs=[];this.selectedID=false;this.p_phraseSelected=-1;this.phraseLength=false}OneWordHelper.prototype.clear=OneWordHelper_clear;OneWordHelper.prototype.getCurrentWord=function(){return this.p_currentWord};OneWordHelper.prototype.highlight=OneWordHelper_highlight;OneWordHelper.prototype.highlightPhrase=OneWordHelper_highlightPhrase;OneWordHelper.prototype.mouseDown=OneWordHelper_mouseDown;OneWordHelper.prototype.phraseAppend=OneWordHelper_phraseAppend;OneWordHelper.prototype.refreshBarPhrase=OneWordHelper_refreshBarPhrase;OneWordHelper.prototype.scrollTo=OneWordHelper_scrollTo;OneWordHelper.prototype.showBar=OneWordHelper_showBar;OneWordHelper.prototype.startPhrase=OneWordHelper_startPhrase;function WordSearchHelper(){}WordSearchHelper.prototype.search=WordSearchHelper_search;function TextDisplay(){this.initialize()}TextDisplay.prototype.initialize=function(){this.p_rawText="";this.redRGBFactor=-1;this.wordN=0;this.pageCount=1;this.charOnPage=0;this.pgChars=1800;this.pageDisplayed=0;this.currentPage=1;this.pagingVisible=false};TextDisplay.prototype.addPageCounts=TextDisplay_addPageCounts;TextDisplay.prototype.checkPaging=TextDisplay_checkPaging;TextDisplay.prototype.newInput=TextDisplay_newInput;TextDisplay.prototype.pageStartCode=TextDisplay_pageStartCode;TextDisplay.prototype.pagingCode=TextDisplay_pagingCode;TextDisplay.prototype.processInput=TextDisplay_processInput;TextDisplay.prototype.progress=TextDisplay_progress;TextDisplay.prototype.reflow=TextDisplay_reflow;TextDisplay.prototype.setPage=TextDisplay_setPage;TextDisplay.prototype.showInputMode=TextDisplay_showInputMode;TextDisplay.prototype.showPending=TextDisplay_showPending;TextDisplay.prototype.showResultsMode=TextDisplay_showResultsMode;TextDisplay.prototype.displayResults=TextDisplay_displayResults;TextDisplay.prototype.formatTextChunk=TextDisplay_formatTextChunk;function WordIndex(){this.initialize()}WordIndex.prototype.initialize=function(){this.isDisplayed=false;this.isIndexed=false;this.p_posIndex={};this.p_wordIDIndex={};this.p_wordPosIndex={};this.p_wordIDKeys=[];this.charCount=0;this.lineBreaksCount=0;this.p_wordCount=0;this.p_wordDiversity=0;this.p_soughtFragm="";this.repeatedNearly=[]};WordIndex.prototype.absorb=WordIndex_absorb;WordIndex.prototype.clear=WordIndex_clear;WordIndex.prototype.getEndPos=function(n){if(this.p_posIndex[n]===undefined)return false;return this.p_posIndex[n]};WordIndex.prototype.getNumbers=WordIndex_getNumbers;WordIndex.prototype.getPositions=WordIndex_getPositions;WordIndex.prototype.getWordCount=function(){return this.p_wordCount};WordIndex.prototype.getWordDiversity=function(){return this.p_wordDiversity};WordIndex.prototype.isRepeatedNearly=WordIndex_isRepeatedNearly;WordIndex.prototype.p_clearPosIndex=WordIndex_clearPosIndex;WordIndex.prototype.p_insert=WordIndex_insert;WordIndex.prototype.p_insertID=WordIndex_insertID;WordIndex.prototype.p_markDisplayed=WordIndex_markDisplayed;WordIndex.prototype.p_normalize=WordIndex_normalize;chlonnik={h:{file:new FileHelper,oneWord:new OneWordHelper,wordSearch:new WordSearchHelper},textDisplay:new TextDisplay,mainIndex:new WordIndex,mode:"input",delays:{delay:20,timeout:100,nextCallback:null,cache:{},intervalID:null},barGoTo:function(id){var words=this.h.oneWord;words.scrollTo(id,false);words.showBar(id)},fileButtonHandler:function(){if(utl.id("load-file-area").style.display=="none"){utl.id("file-button").innerHTML=lang.dict()["Abort_upload"];utl.id("load-file-area").style.display="block";chlonnik.h.file.clearFileInput()}else{utl.id("file-button").innerHTML=lang.dict()["Upload_file"];utl.id("load-file-area").style.display="none";utl.id("load-file-error").style.display="none";utl.id("load-file-error").innerHTML=""}},loadFileHandler:function(event){if(!event.target.files.length)return;var f=event.target.files[0];if(f.type!="application/vnd.openxmlformats-officedocument.wordprocessingml.document")return chlonnik.h.file.blow(lang.dict()["Docx_only"]);var fread=new FileReader;fread.onload=function(event){chlonnik.h.file.feedDocx(event.target.result)};fread.readAsBinaryString(f)},mainButtonHandler:function(){switch(chlonnik.mode){case"input":chlonnik.textDisplay.showPending();window.setTimeout(function(){chlonnik.textDisplay.processInput()},100);break;case"results":chlonnik.textDisplay.newInput();chlonnik.textDisplay.showInputMode();break}},reflowDialog:function(){utl.id("page-count").innerHTML='<input id="new-page-count" value="'+this.textDisplay.pageCount+'">'+' <a href="javascript:chlonnik.reflowOK()">('+lang.dict()["confirm"]+")</a>";utl.id("reflow-link").blur();utl.id("reflow-link").style.display="none"},reflowOK:function(){var newNum=utl.id("new-page-count").value;if(this.textDisplay.reflow(newNum)){utl.id("reflow-link").style.display="inline"}else{utl.id("page-count").innerHTML=this.textDisplay.pageCount;utl.id("reflow-link").style.display="inline";utl.log("Couldn't reflow text to "+newNum+" pages")}},scrollHandler:function(){var docHeight=document.body.offsetHeight||window.document.documentElement.scrollHeight;var winheight=window.innerHeight||document.documentElement.clientHeight;var scrollpoint=window.scrollY||window.document.documentElement.scrollTop;if(scrollpoint+winheight>=docHeight)return;var menu=utl.id("menu");var search=utl.id("wd-search");if(menu.getBoundingClientRect().top<0&&!menu.className){menu.className="sticky-menu";search.className="sticky-wd-search";if(chlonnik.mode=="results"&&utl.id("main-button").getBoundingClientRect().left<utl.id("wd-search").getBoundingClientRect().right)utl.id("main-button").innerHTML=lang.dict()["remove"]}else if((utl.id("text-input").getBoundingClientRect().top>0||utl.id("text-results").getBoundingClientRect().top>0)&&menu.className){menu.className="";search.className="base-wd-search";if(chlonnik.mode=="results")utl.id("main-button").innerHTML=lang.dict()["Load_another"]}var pixel={x:document.documentElement.clientWidth/2,y:document.documentElement.clientHeight/2};var pages=utl.id("results-pages");for(var i=0;i<5;i++){var ctrElem=document.elementFromPoint(pixel.x,pixel.y);if(ctrElem.offsetTop<pages.offsetTop){chlonnik.textDisplay.setPage(1);break}if(ctrElem.nodeName=="SPAN"){var guessPage=Math.floor(chlonnik.textDisplay.pageCount*(ctrElem.offsetTop-pages.offsetTop)/pages.offsetHeight);if(guessPage>chlonnik.textDisplay.pageCount)guessPage=chlonnik.textDisplay.pageCount;var ok=false;for(var j=0;j<5;j++){if(utl.id("pn-"+guessPage).offsetTop>ctrElem.offsetTop){guessPage--;continue}if(guessPage<chlonnik.textDisplay.pageCount&&utl.id("pn-"+(guessPage+1)).offsetTop<ctrElem.offsetTop){guessPage++;continue}ok=true;break}if(ok)chlonnik.textDisplay.setPage(guessPage);return}pixel.x=pixel.x+Math.random()*60-30;pixel.y=pixel.y+Math.random()*60-30}},togglePagingHandler:function(){var pgLinks=utl.id("paging").getElementsByTagName("a");if(chlonnik.textDisplay.pagingVisible){for(var a in pgLinks)pgLinks.item(a).style.display="none";utl.id("paging-toggler").innerHTML="&#x2398;"+lang.dict()["pages"];chlonnik.textDisplay.pagingVisible=false}else{for(var a in pgLinks)pgLinks.item(a).style.display="inline";utl.id("paging-toggler").innerHTML="&#x2397;";chlonnik.textDisplay.pagingVisible=true}}};addLoadEvent(function(){Mousetrap.bind(["command+;","ctrl+;"],chlonnik.mainButtonHandler);utl.id("text-input").placeholder=lang.dict()["app_hint"];utl.id("wd-search-input").placeholder=lang.dict()["find_hint"];utl.id("main-button").onclick=chlonnik.mainButtonHandler;utl.id("text-results").onmousedown=function(event){chlonnik.h.oneWord.mouseDown(event)};document.body.onmousedown=function(event){if(chlonnik.mode=="results"&&(event.target==document.body||event.srcElement==document.body))chlonnik.h.oneWord.mouseDown(event)};utl.id("load-file").addEventListener("change",chlonnik.loadFileHandler,false);utl.id("wd-search-input").onkeyup=function(event){chlonnik.h.wordSearch.search(utl.id("wd-search-input").value)};window.onscroll=function(){window.setTimeout(chlonnik.scrollHandler,500)}});function OneWordHelper_clear(){if(this.phraseLength)for(var i=0;i<this.locs.length;i++)for(var j=0;j<this.phraseLength;j++)utl.id("w-"+(this.locs[i]+j)).className=null;else for(var i=0;i<this.locs.length;i++)utl.id("w-"+this.locs[i]).className=null;this.p_currentWord="";this.locs=[];this.selectedID=false;this.phraseLength=false;utl.id("bottom-bar").style.display="none";utl.id("bt-diagram").style.display="none"}function OneWordHelper_highlight(word,mainID){this.p_currentWord=word;this.locs=chlonnik.mainIndex.getNumbers(this.p_currentWord);for(var i=0;i<this.locs.length;i++){utl.id("w-"+this.locs[i]).className="highlight"}this.showBar(mainID)}function OneWordHelper_highlightPhrase(mainID){for(var i=0;i<this.locs.length;i++)for(var j=0;j<this.phraseLength;j++)utl.id("w-"+(this.locs[i]+j)).className="hl-phrase";this.showBar(this.locs,mainID)}function OneWordHelper_phraseAppend(wordID){this.locs.push(parseInt(wordID))}function OneWordHelper_startPhrase(mainID,len){this.phraseLength=parseInt(len);this.selectedID=parseInt(mainID)}function OneWordHelper_mouseDown(event){if(!chlonnik.mainIndex.isDisplayed)return false;this.clear();var target=event.target||event.srcElement;if(target.id.substr(0,2)!="w-")return false;var selectedID=target.id.substr(2);var word=target.textContent;this.highlight(word,selectedID);this.scrollTo(selectedID,true);return true}function OneWordHelper_refreshBarPhrase(){if(this.locs.length>0)this.showBar(this.locs,this.selectedID)}function OneWordHelper_scrollTo(wordID,fromText){wordID=parseInt(wordID);if(!this.phraseLength){if(this.selectedID)utl.id("w-"+this.selectedID).className="highlight";utl.id("w-"+wordID).className="highlight hl-main"}else{if(this.selectedID)for(var i=0;i<this.phraseLength;i++)utl.id("w-"+(this.selectedID+i)).className="hl-phrase";for(var i=0;i<this.phraseLength;i++)utl.id("w-"+(wordID+i)).className="hl-phrase hl-main"}this.selectedID=wordID;if(!fromText){var height=window.innerHeight||screen.availHeight;var wordLoc=utl.id("w-"+wordID).offsetTop;window.scroll(0,wordLoc-.35*height);this.showBar(wordID)}}function OneWordHelper_showBar(mainID){var ids=this.locs;mainID=parseInt(mainID);utl.id("bottom-bar").style.display="block";if(!ids.length)utl.id("bt-info").innerHTML=lang.dict()["No_occurrences"];else{var here=1+ids.indexOf(mainID);if(here&&here>0)utl.id("bt-info").innerHTML=lang.dict()["Occurrence"]+" <b>"+here+"</b> "+lang.dict()["of"]+" "+ids.length+":";else utl.id("bt-info").innerHTML=lang.dict()["Occurrence_count"]+": <b>"+ids.length+"</b>"}utl.id("bt-diagram").style.display="inline";var diagram=utl.id("bt-diagram");var dotVal=.025*chlonnik.mainIndex.getWordCount();var html="";for(var i=0;i<ids[0]/dotVal;i++)html+=". ";for(var i=0;i<ids.length;i++){var link='<a href="javascript:chlonnik.barGoTo('+ids[i]+')">';link+=utl.id("w-"+ids[i]).textContent.substr(0,1)+"</a>";if(ids[i]==mainID)link="<em>"+link+"</em>";html+=link;if(i!=ids.length-1)for(var j=0;j<Math.floor((ids[i+1]-ids[i])/dotVal);j++)html+=". ";else for(var k=0;k<Math.floor((chlonnik.mainIndex.getWordCount()-ids[i])/dotVal);k++)html+=". "}this.locs=ids;diagram.innerHTML=html}function addLoadEvent(func){var oldonload=window.onload;if(typeof window.onload!="function"){window.onload=func}else{window.onload=function(){if(oldonload){oldonload()}func()}}}function TextDisplay_addPageCounts(){for(var i=1;i<this.pageCount+1;i++){var pageNum=utl.id("pn-"+i).innerHTML;utl.id("pn-"+i).innerHTML=pageNum+" "+lang.dict()["of"]+" "+this.pageCount}}function TextDisplay_checkPaging(){if(this.charOnPage>this.pgChars){this.pageCount++;this.charOnPage-=this.pgChars;return true}return false}function TextDisplay_newInput(){chlonnik.h.oneWord.clear();this.initialize();chlonnik.mainIndex.clear();utl.id("text-input").value="";utl.id("text-results").innerHTML="";utl.id("text-input").style.display="block";utl.id("text-results").style.display="none"}function TextDisplay_processInput(){this.p_rawText=utl.id("text-input").value;chlonnik.mainIndex.absorb(this.p_rawText);this.displayResults()}function TextDisplay_progress(fract){utl.id("main-button").innerHTML=Math.floor(fract*100)+"%"}function TextDisplay_setPage(num){if(utl.id("pgl-"+this.currentPage))utl.id("pgl-"+this.currentPage).className="";utl.id("pgl-"+num).className="current-pg";this.currentPage=num}function TextDisplay_displayResults(){var display=this;var wait=function(){if(!chlonnik.mainIndex.isIndexed)window.setTimeout(wait,chlonnik.delays.delay);else{utl.id("text-input").style.display="none";utl.id("text-results").style.display="block";chlonnik.delays.nextCallback=function(cch){var stepStart=Date.now();for(;cch.i<chlonnik.mainIndex.charCount;cch.i++){if(Date.now()-stepStart>chlonnik.delays.timeout){window.setTimeout(function(){chlonnik.delays.nextCallback(chlonnik.delays.cache)},chlonnik.delays.delay);display.progress(.3+cch.i/chlonnik.mainIndex.charCount*.7);return false}var f=display.formatTextChunk(cch.i);cch.resultText+=f.html;cch.i=f.continue_from}display.showResultsMode();var stats="<div id='results-stats'><h2>"+lang.dict()["Document_stats"]+"</h2><table><tbody>"+"<tr><th>"+lang.dict()["Character_count"]+"</th><td>"+chlonnik.mainIndex.charCount+"</td></tr>"+"<tr><th>"+lang.dict()["Word_count"]+"</th><td>"+chlonnik.mainIndex.getWordCount()+"</td></tr>"+"<tr><th>("+lang.dict()["without_duplicates"]+")</th><td>"+chlonnik.mainIndex.getWordDiversity()+"</td></tr>"+"<tr><th>"+lang.dict()["Page_count"]+" <a id='reflow-link' href='javascript:chlonnik.reflowDialog()'>("+lang.dict()["adjust_pages"]+")</a></th>"+"<td id='page-count'>"+display.pageCount+"</td></tr>"+"</tbody></table></div>";var paging='<div id="paging">'+display.pagingCode()+"</div>";utl.id("text-results").innerHTML=paging+stats+'<div id="results-pages">'+cch.resultText+"</div>";cch.resultText=null;display.addPageCounts();utl.id("pgl-1").className="current-pg";display.currentPage=1;utl.id("paging-toggler").onclick=chlonnik.togglePagingHandler;chlonnik.mainIndex.p_markDisplayed();return true};display.redRGBFactor=Math.floor(1/(Math.pow(chlonnik.mainIndex.charCount,1.5)/210/chlonnik.mainIndex.getWordDiversity())*255);chlonnik.delays.cache={index:chlonnik.mainIndex,resultText:"",i:0};chlonnik.delays.nextCallback(chlonnik.delays.cache)}};wait()}function TextDisplay_formatTextChunk(startpos){var index=chlonnik.mainIndex;ret="";this.checkPaging();if(this.pageDisplayed!=this.pageCount){this.pageDisplayed=this.pageCount;ret+=this.pageStartCode(this.pageCount)}if(index.getEndPos(startpos)===false){if(this.p_rawText[startpos]=="\n"){this.charOnPage+=37;return{html:ret+this.p_rawText[startpos]+"<br>",continue_from:startpos}}this.charOnPage++;return{html:ret+this.p_rawText[startpos],continue_from:startpos}}var word=this.p_rawText.substr(startpos,index.getEndPos(startpos)-startpos+1);if(!index.isDisplayed)var frequency=index.getPositions(word).length;else var frequency=index.getNumbers(word).length;var red=frequency*this.redRGBFactor;if(red>255)red=255;var blue=Math.ceil(176-136*(red/255));var html="<span id=w-"+this.wordN+' style="color: rgb('+red+","+96+","+blue+")";if(word.length>1&&index.isRepeatedNearly(word,startpos,200))html+="; border-bottom: thin dashed #111";html+='">'+word+"</span>";if(!index.isDisplayed)index.p_insertID(word,index.getPositions(word).indexOf(startpos),this.wordN);this.wordN++;this.charOnPage+=word.length;startpos=index.getEndPos(startpos);return{html:ret+html,continue_from:startpos}}function TextDisplay_pageStartCode(num){if(this.pageCount==1)var ret="<div class='first-page-start' id='pg-1'>&nbsp;</div>";else var ret="<div class='page-break' id='pg-"+num+"'>&nbsp;</div>";return ret+"<div class='page-number' id='pn-"+num+"'>"+lang.dict()["page"]+" "+num+"</div>"}function TextDisplay_pagingCode(){var paging="";var dist=1;if(this.pageCount>50)dist=this.pageCount/50;for(var i=0;i<10*dist;i=Math.floor(i+dist)){if(i==0){var j=Math.floor(10*dist);paging+="<span id='paging-toggler'>&#x2397; "+lang.dict()["pages"]+"</span>"}else var j=0;for(;j+i<this.pageCount+1;j+=Math.floor(10*dist))paging+="<a id='pgl-"+(i+j)+"' href='#pg-"+(i+j)+"' style='display:none'>"+(i+j)+"</a> ";paging+="<br>"}return paging}function TextDisplay_reflow(pgCount){this.pgChars=(chlonnik.mainIndex.charCount+36*chlonnik.mainIndex.lineBreaksCount)/pgCount;this.charOnPage=0;this.pageCount=1;this.wordN=0;this.displayResults();return true}function TextDisplay_showInputMode(){chlonnik.mode="input";utl.id("main-button").innerHTML=lang.dict()["Analyze!"];utl.id("wd-search").style.display="none";utl.id("menu").className=""}function TextDisplay_showPending(){chlonnik.mode="pending";utl.id("main-button").innerHTML=lang.dict()["..."]}function TextDisplay_showResultsMode(){chlonnik.mode="results";utl.id("main-button").innerHTML=lang.dict()["Load_another"];utl.id("wd-search").style.display="block"}utl={create:function(arg,json){var elem=document.createElement(arg);for(i in json)elem[i]=json[i];return elem},id:function(arg){return document.getElementById(arg)},log:function(arg){console.log(arg)},intersect:function(a,b){var ai=0,bi=0;var result=new Array;while(ai<a.length&&bi<b.length){if(a[ai]<b[bi]){ai++}else if(a[ai]>b[bi]){bi++}else{result.push(a[ai]);ai++;bi++}}return result}};if(!Object.keys){Object.keys=function(){"use strict";var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if(typeof obj!=="object"&&(typeof obj!=="function"||obj===null)){throw new TypeError("Object.keys called on non-object")}var result=[],prop,i;for(prop in obj){if(hasOwnProperty.call(obj,prop)){result.push(prop)}}if(hasDontEnumBug){for(i=0;i<dontEnumsLength;i++){if(hasOwnProperty.call(obj,dontEnums[i])){result.push(dontEnums[i])}}}return result}}()}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement,fromIndex){var k;if(this==null){throw new TypeError('"this" is null or not defined')}var O=Object(this);var len=O.length>>>0;if(len===0){return-1}var n=+fromIndex||0;if(Math.abs(n)===Infinity){n=0}if(n>=len){return-1}k=Math.max(n>=0?n:len-Math.abs(n),0);while(k<len){if(k in O&&O[k]===searchElement){return k}k++}return-1}}function WordIndex_absorb(text){var index=this;chlonnik.delays.nextCallback=function(cch){if(index.isIndexed)return true;var stepStart=Date.now();for(;cch.i<text.length;cch.i++){if(Date.now()-stepStart>chlonnik.delays.timeout){window.setTimeout(function(){chlonnik.delays.nextCallback(chlonnik.delays.cache)},chlonnik.delays.delay);chlonnik.textDisplay.progress(cch.i/text.length*.3);return false}var chr=text.charAt(cch.i);var chrCode=chr.charCodeAt(0);if(chr!="'"&&chr!="-"&&(chrCode<65||chrCode>90&&chrCode<97||chrCode>172&&chrCode<=176||chr=="„"||chr=="”")){if(chr=="\n")index.lineBreaksCount++;if(cch.word!=cch.strInit){index.p_insert(cch.word,cch.startPos,cch.i-1);cch.word=cch.strInit}continue}if(cch.word===cch.strInit)cch.startPos=cch.i;cch.word+=chr}if(cch.word!=cch.strInit){index.p_insert(cch.word,cch.startPos,cch.i);cch.word=cch.strInit}index.charCount=text.length;index.isIndexed=true;return true};chlonnik.delays.cache={strInit:"",word:"",startPos:0,i:0};chlonnik.delays.nextCallback(chlonnik.delays.cache)}function WordIndex_clear(){this.initialize()}function WordIndex_clearPosIndex(){this.p_wordPosIndex={}}function WordIndex_getNumbers(word,callback,position){word=this.p_normalize(word);if(!callback){if(this.p_wordIDIndex[word])return this.p_wordIDIndex[word].slice(0);else return false}this.p_soughtFragm=word;if(!position)position="a";if(position!="s"&&position!="a"&&position!="e")return console.log("GetNumbers: Bad search direction argument");chlonnik.delays.nextCallback=function(cache){var stepStart=Date.now();var idx=chlonnik.mainIndex;if(word!=idx.p_soughtFragm)return;var ids=[];for(;chlonnik.delays.cache.i<idx.p_wordIDKeys.length;chlonnik.delays.cache.i++){var entry=idx.p_wordIDKeys[chlonnik.delays.cache.i];var fail=false;if(position=="s")for(var j=0;j<word.length;j++)if(entry.charAt(j)!=word.charAt(j)){fail=true;break}if(position=="e"){for(var j=0;j<word.length;j++)if(entry.charAt(entry.length-1-j)!=word.charAt(word.length-1-j)){fail=true;break}}if(position=="a")if(entry.indexOf(word)==-1)fail=true;if(!fail)ids=ids.concat(idx.p_wordIDIndex[entry]);if(Date.now()-stepStart>.8*chlonnik.delays.timeout){chlonnik.delays.cache.i++;window.setTimeout(function(){chlonnik.delays.nextCallback(chlonnik.delays.cache)},chlonnik.delays.delay);callback(ids);return false}}callback(ids);return true};chlonnik.delays.cache.i=0;chlonnik.delays.nextCallback(chlonnik.delays.cache)}function WordIndex_getPositions(word){return this.p_wordPosIndex[this.p_normalize(word)]||false}function WordIndex_insert(word,startPos,endPos){this.p_wordCount++;word=this.p_normalize(word);this.p_posIndex[startPos]=endPos;if(this.p_wordPosIndex.hasOwnProperty(word))this.p_wordPosIndex[word].push(startPos);else{this.p_wordPosIndex[word]=[startPos];this.p_wordDiversity++}}function WordIndex_insertID(word,occurence,id){if(!this.p_wordIDIndex.hasOwnProperty(this.p_normalize(word)))this.p_wordIDIndex[this.p_normalize(word)]=[];this.p_wordIDIndex[this.p_normalize(word)][occurence]=id}function WordIndex_isRepeatedNearly(word,pos,dist){if(this.isDisplayed){if(this.repeatedNearly.indexOf(pos)>0)return true;return false}var positions=this.getPositions(this.p_normalize(word));if(!positions){utl.log("Can't find word in index: "+word);return false}var ind=positions.indexOf(pos);if(!positions||positions.length==1||(ind===0||pos-this.getEndPos(positions[ind-1])>dist)&&(ind+1==positions.length||positions[ind+1]-pos>dist))return false;this.repeatedNearly.push(pos);return true}function WordIndex_markDisplayed(){this.p_clearPosIndex();this.isDisplayed=true;this.p_wordIDKeys=Object.keys(this.p_wordIDIndex)}function WordIndex_normalize(word){if(!word)return"";var word=word.toLowerCase();return word}function WordSearchHelper_search(phrase){chlonnik.h.oneWord.clear();if(phrase.trim().length<=1)return;var words=phrase.trim().split(" ");var index=chlonnik.mainIndex;if(words.length==1){var started=false;index.getNumbers(words[0],function(nums){if(nums&&!started){chlonnik.h.oneWord.startPhrase(nums[0],1);started=true}for(var i=0;i<nums.length;i++)chlonnik.h.oneWord.phraseAppend(nums[i]);chlonnik.h.oneWord.refreshBarPhrase();if(nums.length==0)return;chlonnik.h.oneWord.highlightPhrase(nums[0]);chlonnik.h.oneWord.scrollTo(nums[0],false)},"a");return}if(words.length>2){var pool1=index.getNumbers(words[1]);for(var n=0;n<pool1.length;n++)pool1[n]--;for(var i=2;i<words.length-2;i++){var wpos=index.getNumbers[i];for(var n=0;n<wpos.length;n++)wpos[n]-=i;pool1=utl.intersect(pool1,wpos)}}chlonnik.delays.cache.pool2=[];chlonnik.delays.cache.endWord=words[words.length-1];chlonnik.delays.cache.wordCount=words.length;if(pool1)chlonnik.delays.cache.pool1=pool1;else chlonnik.delays.cache.pool1=false;var startFunc=function(nums){var cache=chlonnik.delays.cache;cache.pool2=cache.pool2.concat(nums);if(cache.i==index.getWordDiversity()){if(cache.pool1)cache.pool1=utl.intersect(cache.pool1,cache.pool2);else cache.pool1=cache.pool2;if(cache.pool1.length==0)return;index.getNumbers(cache.endWord,cache.endFunc,"s")}};chlonnik.delays.cache.endFunc=function(nums){var cache=chlonnik.delays.cache;var firstOccurence=false;for(var i=0;i<nums.length;i++){nums[i]-=cache.wordCount-1;if(cache.pool1.indexOf(nums[i])!=-1){if(!firstOccurence){firstOccurence=nums[i];chlonnik.h.oneWord.startPhrase(nums[i],cache.wordCount)}chlonnik.h.oneWord.phraseAppend(nums[i])}}if(!firstOccurence)return false;chlonnik.h.oneWord.refreshBarPhrase();chlonnik.h.oneWord.scrollTo(firstOccurence,false)};index.getNumbers(words[0],startFunc,"e")}
